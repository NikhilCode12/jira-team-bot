<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Jira from Feedback</title>
  <style>
    :root {
      --bg: #f6f8fa;
      --card: #ffffff;
      --border: #e1e4e8;
      --primary: #0969da;
      --primary-hover: #0550ae;
      --text: #1f2328;
      --text-muted: #656d76;
      --error-bg: #ffebe9;
      --error-text: #cf222e;
      --success-bg: #dafbe1;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,.06);
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 2rem 1rem;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container { max-width: 620px; margin: 0 auto; }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 1.5rem;
      color: var(--text);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin: 0 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-top: 1rem;
      color: var(--text);
    }
    label:first-child { margin-top: 0; }
    input[readonly] { background: var(--bg); color: var(--text-muted); cursor: default; }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      margin-top: 0.25rem;
      font-size: 0.875rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.15);
    }
    textarea { min-height: 140px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 520px) { .row { grid-template-columns: 1fr; } }
    .assignee-wrap { position: relative; }
    .assignee-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 2px;
      max-height: 200px;
      overflow-y: auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: var(--shadow);
      z-index: 10;
      display: none;
    }
    .assignee-list.visible { display: block; }
    .assignee-item {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .assignee-item:last-child { border-bottom: none; }
    .assignee-item:hover { background: var(--bg); }
    .assignee-item small { color: var(--text-muted); margin-left: 0.5rem; }
    .meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem; }
    .btn {
      margin-top: 1.5rem;
      padding: 0.6rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 500;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover { background: var(--primary-hover); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .error {
      background: var(--error-bg);
      color: var(--error-text);
      padding: 0.75rem 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-size: 0.875rem;
      display: none;
    }
    .error.visible { display: block; }
    .result {
      background: var(--success-bg);
      border: 1px solid rgba(26, 127, 55, 0.2);
      color: #1a7f37;
      padding: 1rem 1.25rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-size: 0.875rem;
      display: none;
    }
    .result.visible { display: block; }
    .result a { color: var(--primary); font-weight: 500; }
    .required { color: var(--error-text); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Create Jira from Feedback</h1>
    <p style="margin-bottom:1rem;"><a href="/test-teams">Test Teams → Jira</a> (simulate chat message)</p>

    <form id="form">
      <div class="card">
        <h2>Project &amp; Assignment</h2>
        <label>Project <span class="required">*</span></label>
        <input type="text" name="project" value="{{ project }}" readonly />

        <label>Assignee</label>
        <div class="assignee-wrap">
          <input type="text" id="assignee_search" name="assignee_search" placeholder="Search assignee by name or email..." autocomplete="off" />
          <input type="hidden" name="assignee_account_id" id="assignee_account_id" />
          <div id="assignee_list" class="assignee-list"></div>
        </div>
        <p class="meta" id="assignee_selected"></p>

        <label>Sprint</label>
        <input type="text" name="sprint" placeholder="Optional" />

        <div class="row">
          <div>
            <label>Component</label>
            <select name="component_id" id="component_id">
              <option value="">— Select —</option>
            </select>
          </div>
          <div>
            <label>Priority</label>
            <select name="priority_id" id="priority_id">
              <option value="">— Select —</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Details</h2>
        <div class="row">
          <div>
            <label>Environment</label>
            <input type="text" name="environment" value="Production" placeholder="e.g. Production" />
          </div>
          <div>
            <label>Module</label>
            <input type="text" name="module" value="Super Admin" placeholder="e.g. Super Admin" />
          </div>
        </div>
        <label>Customer Reported Bug</label>
        <select name="customer_reported_bug" id="customer_reported_bug">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
        <label>Customer Name</label>
        <input type="text" name="customer_name" placeholder="NA or customer name" />
        <p class="meta">Epic: {{ epic }} · Labels: {{ labels }}</p>
      </div>

      <div class="card">
        <h2>Feedback</h2>
        <label>Feedback / Bug details <span class="required">*</span></label>
        <textarea name="feedback" id="feedback" required placeholder="Paste or type your description. It will be used as-is in the Jira description. A short summary will be generated automatically."></textarea>
        <label>Screenshots (optional, up to 4)</label>
        <input type="file" id="screenshots" name="screenshots" accept="image/*" multiple />
        <p class="meta">PNG, JPG, or paste images. Max 4 files.</p>
        <button type="submit" id="submitBtn" class="btn">Create Jira</button>
      </div>
    </form>

    <div id="error" class="error"></div>
    <div id="result" class="result">
      <strong>Created:</strong> <span id="issueKey"></span><br />
      <a id="issueLink" href="#" target="_blank" rel="noopener noreferrer">Open in new tab</a>
    </div>
  </div>

  <script>
    const form = document.getElementById('form');
    const submitBtn = document.getElementById('submitBtn');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');
    const issueKeyEl = document.getElementById('issueKey');
    const issueLinkEl = document.getElementById('issueLink');
    const assigneeSearch = document.getElementById('assignee_search');
    const assigneeAccountId = document.getElementById('assignee_account_id');
    const assigneeList = document.getElementById('assignee_list');
    const assigneeSelected = document.getElementById('assignee_selected');
    let assigneeSearchTimer = null;
    let issueCreated = false;

    async function loadOptions() {
      try {
        const [compRes, prioRes] = await Promise.all([
          fetch('/api/components'),
          fetch('/api/priorities')
        ]);
        if (compRes.ok) {
          const comps = await compRes.json();
          const sel = document.getElementById('component_id');
          comps.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.name;
            sel.appendChild(o);
          });
        }
        if (prioRes.ok) {
          const prios = await prioRes.json();
          const sel = document.getElementById('priority_id');
          prios.forEach(p => {
            const o = document.createElement('option');
            o.value = p.id;
            o.textContent = p.name;
            sel.appendChild(o);
          });
        }
      } catch (e) { console.warn('Options load failed', e); }
    }
    loadOptions();

    assigneeSearch.addEventListener('input', () => {
      clearTimeout(assigneeSearchTimer);
      const q = assigneeSearch.value.trim();
      assigneeAccountId.value = '';
      assigneeSelected.textContent = '';
      if (q.length < 2) {
        assigneeList.classList.remove('visible');
        assigneeList.innerHTML = '';
        return;
      }
      assigneeSearchTimer = setTimeout(async () => {
        try {
          const r = await fetch('/api/assignable-users?query=' + encodeURIComponent(q));
          const users = await r.json();
          assigneeList.innerHTML = '';
          if (users.length === 0) {
            assigneeList.innerHTML = '<div class="assignee-item" style="cursor:default;color:var(--text-muted)">No users found</div>';
          } else {
            users.forEach(u => {
              const div = document.createElement('div');
              div.className = 'assignee-item';
              div.textContent = u.displayName || u.accountId;
              if (u.emailAddress) {
                const small = document.createElement('small');
                small.textContent = u.emailAddress;
                div.appendChild(small);
              }
              div.dataset.accountId = u.accountId;
              div.dataset.displayName = u.displayName || u.accountId;
              div.addEventListener('click', () => {
                assigneeAccountId.value = u.accountId;
                assigneeSearch.value = u.displayName || u.accountId;
                assigneeSelected.textContent = 'Selected: ' + (u.displayName || u.accountId);
                assigneeList.classList.remove('visible');
                assigneeList.innerHTML = '';
              });
              assigneeList.appendChild(div);
            });
          }
          assigneeList.classList.add('visible');
        } catch (e) {
          assigneeList.innerHTML = '<div class="assignee-item" style="cursor:default;color:var(--error-text)">Search failed</div>';
          assigneeList.classList.add('visible');
        }
      }, 300);
    });
    assigneeSearch.addEventListener('focus', () => {
      if (assigneeList.children.length) assigneeList.classList.add('visible');
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.assignee-wrap')) assigneeList.classList.remove('visible');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (issueCreated) return;
      errorEl.classList.remove('visible');
      resultEl.classList.remove('visible');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating…';
      const feedback = document.getElementById('feedback').value.trim();
      if (!feedback) {
        errorEl.textContent = 'Feedback is required.';
        errorEl.classList.add('visible');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Jira';
        return;
      }
      const formData = new FormData();
      formData.append('feedback', feedback);
      formData.append('sprint', form.sprint.value.trim() || '');
      formData.append('component_id', form.component_id.value || '');
      formData.append('priority_id', form.priority_id.value || '');
      formData.append('assignee_account_id', assigneeAccountId.value || '');
      formData.append('environment', form.environment.value.trim() || '');
      formData.append('module', form.module.value.trim() || '');
      formData.append('customer_reported_bug', form.customer_reported_bug.value || '');
      formData.append('customer_name', form.customer_name.value.trim() || '');
      const fileInput = document.getElementById('screenshots');
      if (fileInput.files.length) {
        const max = Math.min(fileInput.files.length, 4);
        for (let i = 0; i < max; i++) formData.append('screenshots', fileInput.files[i]);
      }
      try {
        const r = await fetch('/create-jira', {
          method: 'POST',
          body: formData
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          errorEl.textContent = data.detail || data.message || r.statusText;
          errorEl.classList.add('visible');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Jira';
          return;
        }
        issueCreated = true;
        issueKeyEl.textContent = data.key;
        issueLinkEl.href = data.url;
        issueLinkEl.textContent = 'Open ' + data.key + ' in new tab';
        resultEl.classList.add('visible');
        submitBtn.textContent = 'Created';
      } catch (err) {
        errorEl.textContent = err.message || 'Request failed';
        errorEl.classList.add('visible');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Jira';
      }
    });
  </script>
</body>
</html>
